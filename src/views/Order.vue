<template>
    <div class="container">
        <h1>Оформление заявки</h1>

        <ProgresBar v-model="step"/>

        <div class="onboarding-buttons">
            <button class="onboarding-button onboarding-button_secondary" @click="()=>updateE(-1)" :disabled="loading">
                <div class="onboarding-button__inner">
                    <span class="onboarding-button__label">Назад</span>
                </div>
            </button>
            <button class="onboarding-button" @click="submitHandler" :disabled="loading">
                <div class="onboarding-button__inner">
                    <span class="onboarding-button__label">Вперед</span>
                    <svg class="onboarding-button__icon" viewBox="0 0 42 35" xmlns="http://www.w3.org/2000/svg">
                        <path d="M31.8233 8.64617L31.8223 8.6497C31.2506 10.5076 30.1844 11.9879 28.9431 12.8927C27.7025 13.7971 26.3144 14.1121 25.0483 13.7192L25.0484 13.7191L25.0375 13.716C23.8391 13.3736 22.9129 12.3546 22.4241 10.9C21.936 9.44715 21.9054 7.60491 22.478 5.74379C23.0497 3.88587 24.1159 2.40563 25.3572 1.50078C26.597 0.596967 27.9841 0.281764 29.2495 0.673526C30.4579 1.0629 31.3873 2.11359 31.8762 3.56849C32.3647 5.02244 32.3942 6.83859 31.8233 8.64617Z"/>
                        <path d="M32.2759 15.6536C32.849 13.8866 33.8452 12.4767 34.9791 11.6089C36.1134 10.7408 37.3481 10.4372 38.4532 10.7772C39.5489 11.1143 40.3793 12.077 40.7967 13.4566C41.2135 14.8345 41.1973 16.5795 40.6247 18.3451C40.0516 20.1121 39.0553 21.522 37.9214 22.3898C36.7871 23.2579 35.5524 23.5615 34.4473 23.2214C33.3516 22.8843 32.5212 21.9217 32.1038 20.542C31.687 19.1642 31.7032 17.4192 32.2759 15.6536Z"/>
                        <path d="M16.5581 14.0187L16.5501 14.021L16.5421 14.0237C15.4034 14.4032 14.1021 14.0651 12.8727 13.0933C11.6468 12.1242 10.5473 10.5601 9.87334 8.63639C9.2521 6.77047 9.21236 4.92545 9.63094 3.46041C10.0494 1.99569 10.9059 0.960017 12.0503 0.575067C13.1981 0.238442 14.5306 0.585361 15.7692 1.54353C17.0066 2.50072 18.1023 4.03774 18.7247 5.95259C19.3488 7.873 19.3881 9.74548 18.9694 11.2107C18.5502 12.678 17.6946 13.6819 16.5581 14.0187Z"/>
                        <path d="M9.32705 15.6609L9.32703 15.6609L9.3284 15.6648C9.94964 17.4329 10.0122 19.1778 9.63082 20.5529C9.24934 21.9285 8.4441 22.8854 7.35309 23.2211C6.25468 23.5591 4.99602 23.2379 3.81824 22.3283C2.6432 21.4208 1.59582 19.9571 0.973215 18.1372L0.973231 18.1372L0.971863 18.1333C0.35063 16.3652 0.288103 14.6203 0.66945 13.2451C1.05093 11.8695 1.85617 10.9126 2.94718 10.5769C4.04558 10.2389 5.30425 10.5602 6.48202 11.4698C7.65707 12.3772 8.70444 13.8409 9.32705 15.6609Z"/>
                        <path d="M10.0002 29.8984L10.0002 29.8945C9.95153 23.7173 12.5904 20.2377 15.2112 18.287C16.5308 17.3049 17.8556 16.704 18.8509 16.3491C19.348 16.1718 19.761 16.0566 20.0473 15.9861C20.1904 15.9508 20.3017 15.9268 20.3758 15.9118C20.4043 15.9061 20.4273 15.9016 20.4445 15.8984H20.9559C20.9731 15.9016 20.9962 15.9061 21.0248 15.9118C21.0989 15.9268 21.2102 15.9508 21.3534 15.986C21.6398 16.0563 22.0529 16.1712 22.5501 16.3477C23.5457 16.7013 24.8707 17.2992 26.1903 18.2754C28.8114 20.2143 31.4488 23.6689 31.4002 29.7945L31.4001 29.7945L31.4002 29.8051C31.4245 31.6219 31.0644 32.6943 30.5914 33.316C30.1308 33.9211 29.5133 34.1638 28.8512 34.2123C28.1751 34.2617 27.4743 34.1045 26.9247 33.9223C26.6536 33.8324 26.4275 33.7392 26.2702 33.669C26.1941 33.6351 26.1346 33.6067 26.0944 33.5869C26.076 33.5692 26.0535 33.5478 26.0272 33.523C25.9479 33.4482 25.8333 33.3425 25.6891 33.2162C25.4014 32.964 24.9934 32.6272 24.5127 32.2893C23.5763 31.6314 22.2659 30.8984 21.0002 30.8984H20.9588L20.918 30.9052L20.3571 30.9987C19.1048 31.015 17.8135 31.7388 16.8877 32.3893C16.407 32.7272 15.999 33.064 15.7113 33.3162C15.5671 33.4425 15.4525 33.5482 15.3732 33.6229C15.3474 33.6472 15.3254 33.6682 15.3073 33.6857C15.2679 33.7047 15.2105 33.7315 15.1375 33.7635C14.983 33.8311 14.7606 33.9209 14.4936 34.0069C13.9526 34.1814 13.2613 34.33 12.591 34.2751C11.9344 34.2213 11.316 33.9758 10.8491 33.371C10.3705 32.7512 10.0002 31.689 10.0002 29.8984Z"/>
                    </svg>
                </div>
            </button>
        </div>

        <p>
            <span>{{step}}</span> из <span>{{steps.length}}</span>
        </p>

        <div>
            <button @click="()=>updateE(-1)"> -</button>
            <button @click="()=>updateE(1)"> +</button>
        </div>

        <div>
          <br>
          <label>
            <input type="checkbox" v-model="enableValidation">
            Validation: {{ enableValidation }}
          </label>
          <br>
          <br>
        </div>

        <div class="transition-box">
            <transition name="translate">
                <div class="abs" v-if="step === 'step-1'">
                    <Step1 ref="form" :order.sync="order" />
                </div>
            </transition>

            <transition name="translate">
                <div class="abs" v-if="step === 'step-2'">
                    <Step2 ref="form" :order.sync="order" />
                </div>
            </transition>

            <transition name="translate">
                <div class="abs" v-if="step === 'step-3'">

                  <template v-if="loading">
                      <div class="overlay">
                          <Loader />
                      </div>
                  </template>
                  <Step3 ref="form" :order.sync="order" />
                </div>
            </transition>

            <transition name="translate">
                <div class="abs" v-if="step === 'step-4'">
                    <p>данные отправлены...</p>
                </div>
            </transition>

        </div>

    </div>
</template>

<script>
  import { email, required, minLength, maxLength, numeric } from 'vuelidate/lib/validators'
  import ProgresBar from '../components/onboarding/ProgresBar'
  import Step1 from '../components/onboarding/orderSteps/Step1'
  import Step2 from '../components/onboarding/orderSteps/Step2'
  import Step3 from '../components/onboarding/orderSteps/Step3'
  import Loader from '../components/Loader'

  export default {
    name: 'Order',
    components: {
      Step1,
      Step2,
      Step3,
      ProgresBar,
      Loader,
    },
    metaInfo: {
      title: 'Order',
    },
    data: () => ({
      step: 'step-1',
      steps: ['step-1', 'step-2', 'step-3', 'step-4'],
      order: {},
      loading: false,
      enableValidation: false
    }),
    validations () {
      return { ...this.v }
    },
    methods: {
      onClick (e) {
        this.coords = e.get('coords')
      },
      updateE (val = 1) {
        const idx = this.steps.indexOf(this.step)
        const len = this.steps.length
        if (idx !== -1 && idx + val <= len - 1 && idx + val >= 0) {
          this.step = this.steps[idx + val]
        }
      },
      submitHandler () {
        if (this.loading) return
        const v = this.$refs.form && this.$refs.form.$v
        if (this.enableValidation && v) {
          v.$touch()
          if (v.$invalid) {
            return
          }
        }
        if (this.step === 'step-3') {
          this.loading = true
          this.$store.dispatch('order/createOrder', this.order)
            .then(isSuccess => {
              this.loading = false
              if (isSuccess) {
                this.updateE(1)
              }
            })
        } else {
          this.updateE(1)
        }
      },
    },
  }
</script>

<style lang="scss" scoped>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap');

    .overlay {
      position: absolute;
      background-color: rgba(255,255,255, 0.7);
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 555;
    }

    .onboarding {
        &-buttons {
            width: 100%;
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
        }

        &-button {
            font-family: Montserrat, sans-serif;
            position: relative;
            min-width: 230px;
            padding: 15px 55px;
            background-color: #FFCC01;
            border: none;
            border-radius: 10px;
            box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.1);

            font-weight: 600;
            font-size: 21px;
            line-height: 26px;
            text-align: center;
            letter-spacing: 0.2px;
            color: #464451;

            &_secondary {
                color: #2289B5;
                background-color: #fff;
                border: 1px solid #2289B5;
                box-sizing: border-box;
                border-radius: 10px;

                &:hover {
                    background-color: lighten(#2289B5, 50);
                }

                &:active {
                    background-color: lighten(#2289B5, 40);
                }
            }

            &__inner {
                position: relative;
                display: inline-block;
            }

            &__icon {
                position: absolute;
                left: 100%;
                fill: #fff;
                stroke: #C8A20F;
                stroke-width: 1px;
                height: 100%;
                margin-left: 10px;
            }

            &:hover {
                box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.2);
                cursor: pointer;
            }

            &:active {
                box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.1);
            }

            &:active &__icon {
                fill: #2289B5;
            }
        }
    }

        .scale-in-hor-left {
            animation: scale-in-hor-left 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }

        @keyframes scale-in-hor-left {
            0% {
                transform: scaleX(0);
                transform-origin: 0% 0%;
                opacity: 1;
            }
            100% {
                transform: scaleX(1);
                transform-origin: 0% 0%;
                opacity: 1;
            }
        }

        .container {
            width: 920px;
            margin: 0 auto;
        }

        .transition-box {
            position: relative;
        }

        .translate-enter-active,
        .translate-leave-active {
            transition: all .5s;
        }

        .translate-enter,
        .translate-leave-active {
            opacity: 0;
        }

        .translate-enter {
            transform: translateX(31px);
        }

        .translate-leave-active {
            transform: translateX(-31px);
        }

        .abs {
            position: absolute;
            right: 0;
            left: 0;
        }
</style>
